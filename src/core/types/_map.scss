////
/// concrete | src/core/types/_map.scss
///
/// Some extra map related functions.
///
/// Tests:
/// ✓ is-map
/// ✓ map-add
/// ✓ map-replace
/// ✓ map-append
/// ✓ map-get-key
/// - map-sort
/// ✓ map-ksort
///
/// @group core
////

// -----------------------------------------------------------------------------
// Type check related functions.
// -----------------------------------------------------------------------------

///
/// Returns `true` if `$var` is a map with the minimum length of `$length`.
/// When no length is given or is not a valid number, the length check is
/// skipped.
///
/// @param {mixed} $var
/// @param {bool|number} $length
/// @return {bool}
///
@function is-map($var, $length: false)
{
    $result: (type-of($var) == 'map');
    @if $result and is-number($length)
    {
        $result: (length($var) >= $length);
    }

    @return $result;
}

// -----------------------------------------------------------------------------

///
/// Adds a key to a map when it does not exist in the map. If it does, the
/// original map is returned.
///
/// @param {map} $map The map holding the key and value pairs.
/// @param {string} $key The key to add to the map.
/// @param {mixed} $value The value to add to the map.
/// @param {bool} $replace [false] Replace the key when it already exists
/// @param {string} $seperator [auto]
/// @return {map} Returns a new map with the added or replaced key and value.
///
@function map-add($map, $key, $value, $replace: false, $seperator: 'auto')
{
    $add: true;

    @if map-has-key($map, $key)
    {
        $add: false;

        @if is-true($replace)
        {
            $map: map-remove($map, $key);
            $add: true;
        }
    }

    @if is-true($add)
    {
        $map: map-merge($map, ($key: $value));
    }

    @return $map;
}

///
/// Replace an existing key in a map with a new value. When the key does not
/// exist it returns the original map.
///
/// @param {map} $map The map holding the key and value pairs.
/// @param {string} $key The key in the map to replace the value from
/// @param {mixed} $value The value to replace the entry in the map with.
/// @param {bool} $add [false] Add the key + value entry when not in the map.
/// @param {string} $seperator [auto]
/// @return {map} Returns a new map with the replaced or added key and value.
///
@function map-replace($map, $key, $value, $add: false, $seperator: 'auto')
{
    @if map-has-key($map, $key)
    {
        $map: map-remove($map, $key);
        $add: true;
    }

    @if is-true($add)
    {
        $map: map-merge($map, ($key: $value));
    }

    @return $map;
}

///
/// Append a value to an existing entry in a map or creates a new entry.
///
/// @param {map} $map The map holding the key and value pairs.
/// @param {string} $key The key in the map to append the value to.
/// @param {mixed} $value The value to append to the entry in the map.
/// @param {string} $seperator [auto]
/// @return {map} Returns a new map with the added value.
///
@function map-append($map, $key, $value, $seperator: 'auto')
{
    @if map-has-key($map, $key)
    {
        // append the extra value to the already existing value
        $value: append(map-get($map, $key), $value, $seperator);
        // remove the existing key
        $map: map-remove($map, $key);
    }

    // merge the key and value to the map
    $map: map-merge($map, ($key: $value));
    @return $map;
}

///
/// Finds and returns the key of first occurance of `$value` in `$map`.
///
/// @param {map} $map
/// @param {mixed} $value
/// @return {mixed}
///
@function map-get-key($map, $value)
{
    $index: index(map-values($map), $value);
    @return if(not is-null($index), nth(map-keys($map), $index), null);
}

@function map-default-get($map, $key, $defaultValue)
{
    @return if(map-has-key($map, $key), map-get($map, $key), $defaultValue);
}

///
/// Sort map according to values.
///
/// @param {map} $map
/// @param {string} $type [regular]
/// @param {bool} $reverse [false]
/// @return {map}
///
/// @todo Make sorting of maps with multiple equal values possible.
///
@function map-sort($map, $type: 'regular', $reverse: false)
{
    $result:     ();
    $keysList:   map-keys($map);
    $valuesList: map-values($map);
    $values:     list-sort($valuesList, $type, $reverse);

    @each $value in $values
    {
        $index:  index($valuesList, $value);
        $key:    nth($keysList, $index);
        $result: map-merge($result, ($key: $value));
    }

    @return $result;
}

///
/// Sort map according to keys.
///
/// @param {map} $map
/// @param {string} $type [regular]
/// @param {bool} $reverse [false]
/// @return {map}
///
@function map-ksort($map, $type: 'regular', $reverse: false)
{
    $result: ();
    $keys:   list-sort(map-keys($map), $type, $reverse);

    @each $key in $keys
    {
        $value:  map-get($map, $key);
        $result: map-merge($result, ($key: $value));
    }

    @return $result;
}
